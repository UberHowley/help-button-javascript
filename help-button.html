<!DOCTYPE html>
<html>
<head>
<script>
$( document ).ajaxComplete(function( event, xhr, settings ) {
    
    var url = settings.url;   
    var regX  = /\/discussion\/.*\/threads\/create\?ajax=1/; // regular expression for URLs of  ajax calls for creation of discussion posts

    // We are interested only in Ajax calls for creation of discussion posts
  	if ( regX.test(url)) {

        document.getElementById("help").innerHTML = "In a moment, we will show you some fellow students who should be able to answer your question.";

        var data = JSON.parse(xhr.responseText);
    
    	var content     = data.content;
    	var title       = content.title.toString();
    	var body        = content.body.toString();
    	var threadId    = content.id.toString();
        var userId      = content.user_id.toString();
      
    	var re1 = /create\?ajax=1/g;
    	url = url.replace(re1,threadId);  
 
        // Question recommendation system server URL
		var helpBackEndURL = "https://erebor.lti.cs.cmu.edu:2020/";
        
        // First ajax call to check if server is up
        // If server is not up (may be for maintenance), we will hit back-up server
        // Second ajax call to actually hit the server giving input and getting output
		$.ajax({
            url: helpBackEndURL,
        	type: "HEAD",
        	timeout:1000,
        	statusCode: {
            	400: function (response) {
                    // Back-up server
                    helpBackEndURL = "https://erebor.lti.cs.cmu.edu:2021/";
            	},
            	0: function (response) {
                    // Back-up server
                    helpBackEndURL = "https://erebor.lti.cs.cmu.edu:2021/";
            	}              
        	},
            complete: function() {

        		// Make an Ajax call to the question recommendation system server when a new post is created via help button
        		$.ajax({
            		type: "POST",
            		contentType: "application/json; charset=utf-8",
            		url: helpBackEndURL,
                  data: { "title": title, "body": body,"threadId": threadId, "url": url, "userId" : userId },
            		async: false,
            		dataType: "jsonp",
            		jsonp: "callback",
            		jsonpCallback:"callback",
            		// Callback function which will pop up candidates suggested by question recommendation system
            		success: function (data, textStatus, XMLHttpRequest) {
                		var htmlContent = data; // It contains information about candidates 
                                        		// suggested by question recommendation system 
                
                		//Open window which will allow to choose among candidates suggested by question recommendation system
                		var opened_window = window.open("", "mywindow","menubar=1,resizable=1,width=1000,height=800");
                		opened_window.document.write(htmlContent);
                		opened_window.onbeforeunload = closingCode;
                
                		function closingCode(){
                    		var re2 = /\/discussion\//g;
    						url = url.replace(re2,"/discussion/forum/"); 
			        		document.getElementById("help").innerHTML = "Your help request has been sent to the helper(s) selected by you and it can be accessed <a href=\"https://www.edx.org/" + url + "\">here</a> in the discussion forum.";
   			        		return null;
			    		}
            		}
        		});
            }
 		});
 	}
});
  

</script>
</head>

<body>

<h1>Quick Helper</h1>

<div id="help">Enter your help request below, and we will find some helpers to invite to your discussion thread. <br><br> <b>Note: Quick Helper needs pop-ups being enabled to work.</b> </div>


</body>
</html>
