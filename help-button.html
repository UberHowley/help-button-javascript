<!DOCTYPE html>
<html>
<head>
<script>
$( document ).ajaxComplete(function( event, xhr, settings ) {
    
    var url = settings.url;   
    var regX  = /\/discussion\/.*\/threads\/create\?ajax=1/; // regular expression for URLs of  ajax calls for creation of discussion posts

    // We are interested only in Ajax calls for creation of discussion posts
  	if ( regX.test(url)) {

        document.getElementById("help").innerHTML = "In a moment, we will show you some fellow students who should be able to answer your question.";
        $('html,body').animate({scrollTop: $('#title').offset().top}, 'slow');

        var data = JSON.parse(xhr.responseText);
    
    	var content     = data.content;
    	var title       = content.title.toString();
    	var body        = content.body.toString();
    	var threadId    = content.id.toString();
        var userId      = content.user_id.toString();
      
    	var re1 = /create\?ajax=1/g;
    	url = url.replace(re1,threadId);  
 
        // Question recommendation system server URL
		var helpBackEndURL = "https://erebor.lti.cs.cmu.edu:2020/";
        
        // First ajax call to check if server is up
        // If server is not up (may be for maintenance), we will hit back-up server
        // Second ajax call to actually hit the server giving input and getting output
		$.ajax({
            url: helpBackEndURL,
        	type: "HEAD",
        	timeout:1000,
        	statusCode: {
            	400: function (response) {
                    // Back-up server
                    helpBackEndURL = "https://erebor.lti.cs.cmu.edu:2021/";
            	},
            	0: function (response) {
                    // Back-up server
                    helpBackEndURL = "https://erebor.lti.cs.cmu.edu:2021/";
            	}              
        	},
            complete: function() {

        		// Make an Ajax call to the question recommendation system server when a new post is created via help button
        		$.ajax({
            		type: "POST",
            		contentType: "application/json; charset=utf-8",
            		url: helpBackEndURL,
                  data: { "title": title, "body": body,"threadId": threadId, "url": url, "userId" : userId },
            		async: false,
            		dataType: "jsonp",
            		jsonp: "callback",
            		jsonpCallback:"callback",
            		// Callback function which will pop up candidates suggested by question recommendation system
            		success: function (data, textStatus, XMLHttpRequest) {
                		var htmlContent = data; // It contains information about candidates 
                                        		// suggested by question recommendation system 
                        document.getElementById("help").innerHTML = htmlContent;
                        $('html,body').animate({scrollTop: $('#title').offset().top}, 'slow');
            		}
        		});
            }
 		});
 	}
});
  

</script>
</head>

<body>

<div id ="title"><h1>Quick Helper</h1></div>

<div id="help">Enter your help request below, and we will find some helpers to invite to your discussion thread.</div>


</body>
</html>
